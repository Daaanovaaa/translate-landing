<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translate This Newsletter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }
        #url-input, #submit-url {
            display: none;
            margin: 20px auto;
            padding: 10px;
            width: 80%;
            max-width: 500px;
        }
        #debug {
            display: none;
            margin-top: 20px;
            text-align: left;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            background: #f0f0f0;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h2>🌍 Translate This Newsletter</h2>
    <p>Select your language to open a translated version of this newsletter:</p>

    <button data-lang="es">🇪🇸 Español</button>
    <button data-lang="fr">🇫🇷 Français</button>
    <button data-lang="pt">🇵🇹 Português</button>
    <button data-lang="de">🇩🇪 Deutsch</button>
    <button data-lang="zh-CN">🇨🇳 中文</button>
    <button data-lang="ar">🇸🇦 العربية</button>
    <button data-lang="hi">🇮🇳 हिन्दी</button>
    <button data-lang="ja">🇯🇵 日本語</button>
    <button data-lang="ru">🇷🇺 Русский</button>

    <input type="text" id="url-input" placeholder="Paste the 'View in Browser' URL here">
    <button id="submit-url">Submit URL</button>

    <div id="debug"></div>

    <script>
        // Valid language codes for Google Translate
        const validLanguages = ['es', 'fr', 'pt', 'de', 'zh-CN', 'ar', 'hi', 'ja', 'ru'];

        // Function to build and open Google Translate URL
        function openTranslateURL(lang, url) {
            if (!validLanguages.includes(lang)) {
                alert('Invalid language selected: ' + lang);
                return;
            }
            if (!url || url.includes('example.com') || !url.startsWith('https://')) {
                alert('Invalid or missing newsletter URL. Please paste the "View in Browser" URL.');
                document.getElementById('url-input').style.display = 'block';
                document.getElementById('url-input').value = url || '';
                document.getElementById('submit-url').style.display = 'block';
                return;
            }
            const translateURL = `https://translate.google.com/translate?sl=auto&tl=${lang}&u=${encodeURIComponent(url)}&_x_tr_pto=wapp`;
            window.open(translateURL, '_blank');
        }

        // Get query parameters from URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Debug logging
        function logDebug(message) {
            const debugDiv = document.getElementById('debug');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML += `<p>${message}</p>`;
        }

        // Get lang and URL from query parameters
        const lang = getQueryParam('lang');
        const newsletterUrl = getQueryParam('url');

        // Log parameters for debugging
        logDebug(`Language: ${lang || 'none'}`);
        logDebug(`Newsletter URL: ${newsletterUrl || 'none'}`);
        logDebug(`Referrer: ${document.referrer || 'none'}`);

        // Attempt immediate translation if lang and URL are provided
        if (lang && newsletterUrl) {
            logDebug(`Attempting to translate with lang=${lang} and url=${newsletterUrl}`);
            openTranslateURL(lang, newsletterUrl);
        } else {
            logDebug('Missing lang or URL, showing input field');
            document.getElementById('url-input').style.display = 'block';
            document.getElementById('submit-url').style.display = 'block';
            if (!lang) {
                alert('No language specified. Please select a language or paste the "View in Browser" URL.');
            } else if (!newsletterUrl) {
                alert('No newsletter URL provided. Please paste the "View in Browser" URL.');
            }
        }

        // Handle button clicks
        document.querySelectorAll('button[data-lang]').forEach(button => {
            button.addEventListener('click', () => {
                const lang = button.getAttribute('data-lang');
                logDebug(`Button clicked for lang=${lang}`);
                if (newsletterUrl && !newsletterUrl.includes('example.com') && newsletterUrl.startsWith('https://')) {
                    openTranslateURL(lang, newsletterUrl);
                } else {
                    document.getElementById('url-input').style.display = 'block';
                    document.getElementById('submit-url').style.display = 'block';
                    alert('Please paste the "View in Browser" URL from your email and click Submit.');
                }
            });
        });

        // Handle manual URL submission
        document.getElementById('submit-url').addEventListener('click', () => {
            const manualURL = document.getElementById('url-input').value.trim();
            const selectedLang = lang || getQueryParam('lang') || 'es'; // Default to 'es'
            logDebug(`Manual URL submitted: ${manualURL}, lang=${selectedLang}`);
            openTranslateURL(selectedLang, manualURL);
        });
    </script>
</body>
</html>
